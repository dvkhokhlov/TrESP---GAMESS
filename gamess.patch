--- mthlib.src	2018-02-22 19:28:03.191649774 +0300
+++ mthlib_new.src	2018-02-22 19:26:40.195927327 +0300
@@ -2198,6 +2198,46 @@
  9048 FORMAT(I5,2X,A8,10F11.6)
       END
 C
+C WRITE MATRIX IN EXTENDED FORMAT 
+C*MODULE MTHLIB  *DECK PRSQLE
+      SUBROUTINE PRSQLE(V,M,N,NDIM)
+C
+      IMPLICIT DOUBLE PRECISION(A-H,O-Z)
+C
+      LOGICAL GOPARR,DSKWRK,MASWRK
+C
+      PARAMETER (MXATM=5000, MXAO=16384)
+C
+      DIMENSION V(NDIM,M)
+C
+      COMMON /IOFILE/ IR,IW,IP,IJK,IJKT,IDAF,NAV,IODA(950)
+      COMMON /OUTPUT/ NPRINT,ITOL,ICUT,NORMF,NORMP,NOPK
+      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
+      COMMON /RUNLAB/ TITLE(10),ANAM(MXATM),BNAM(MXATM),BFLAB(MXAO)
+C
+C     ----- PRINT OUT A SQUARE MATRIX WITH BASIS SET LABELS -----
+C     -V- IS -N- ROWS BY -M- COLUMNS, WITH LEADING DIMENSION -NDIM-
+C
+      IF (MASWRK) THEN
+      MAX = 5
+      IF (NPRINT .EQ. 6) MAX = 10
+      IMAX = 0
+  100 IMIN = IMAX+1
+      IMAX = IMAX+MAX
+      IF (IMAX .GT. M) IMAX = M
+      WRITE (IW,9008)
+      WRITE (IW,9028) (I,I = IMIN,IMAX)
+      WRITE (IW,9008)
+      DO 120 J = 1,N
+  120 WRITE (IW,9048) J,BFLAB(J),(V(J,I),I = IMIN,IMAX)
+      IF (IMAX .LT. M) GO TO 100
+      END IF
+      RETURN
+ 9008 FORMAT(1X)
+ 9028 FORMAT(15X,10(7X,I4,6X))
+ 9048 FORMAT(I5,2X,A12,10E17.9)
+      END
+C
 C*MODULE MTHLIB  *DECK PRTRI
       SUBROUTINE PRTRI(D,N)
 C

--- prpel.src	2016-08-15 17:22:40.000000000 +0300
+++ prpel_new.src	2018-02-22 19:17:30.499018347 +0300
@@ -1118,6 +1118,14 @@
       IF(IEMOM.GT.1) WRITE(IW,940) QXX,QYY,QZZ,QXY,QXZ,QYZ
       IF(IEMOM.GT.2) WRITE(IW,950) OXXX,OXXY,OXXZ,OXYY,OYYY,OYYZ,
      *                             OXZZ,OYZZ,OZZZ,OXYZ
+C     -- WRITE X(IDENSA) IN AO's
+      IF(MASWRK) THEN
+	     WRITE(IW,*) ''
+         WRITE(IW,*) '-------------------------'
+         WRITE(IW,*) '      DENSITY MATRIX     '
+         WRITE(IW,*) '-------------------------'
+         CALL PRSQLE(X(IDENSA),L1,L1,L1)
+      END IF 
   310 CONTINUE
       IF(.NOT.PUNCH) GO TO 210
       WRITE(IP,960) IPOINT,XP,YP,ZP,DMX,DMY,DMZ
       
--- tddft.src	2018-02-17 20:54:41.611462570 +0300
+++ tddft_new.src	2018-02-17 20:50:29.399847652 +0300
@@ -2341,6 +2341,8 @@
 C
       IMPLICIT DOUBLE PRECISION (A-H,O-Z)
       PARAMETER (ZERO=0.0D+00,ONE=1.0D+00)
+      LOGICAL MASWRK
+      COMMON /PAR   / ME,MASTER,NPROC,IBTYP,IPTIM,GOPARR,DSKWRK,MASWRK
       COMMON /IOFILE/ IR,IW,IP,IS,IPK,IDAF,NAV,IODA(950)
       COMMON /XYZPRP/ XP,YP,ZP,
      *                DMX,DMY,DMZ,
@@ -2379,6 +2381,16 @@
 C
        CALL DGEMM('N','N',L1,LX,LX,ONE,V,L1,TDEN,LX,ZERO,SCR,L1)
        CALL DGEMM('N','T',L1,L1,LX,ONE,SCR,L1,V,L1,ZERO,TDEN,L1)
+
+C     -- WRITE TDEN IN AO's
+      IF(MASWRK) THEN
+         WRITE(IW,*) '-------------------------'
+         WRITE(IW,*) 'TRANSITION DENSITY MATRIX'
+         WRITE(IW,*) '-------------------------'
+         WRITE(IW,*) 'STATE1=',0,'STATE2=',IST
+         CALL PRSQLE(TDEN,L1,L1,L1)
+      END IF
+      
 C
 C     -- TRANSITION DIPOLE
 C

--- trnstn.src	2018-06-06 18:00:50.573119371 +0300
+++ trnstn.src.new	2018-06-06 18:00:38.952578430 +0300
@@ -2395,7 +2395,16 @@
  460  CONTINUE
 C
       CALL DAWRIT(IDAF,IODA,TDM,L2,250,0)
-C
+
+C     -- WRITE TDEN IN AO's
+      IF(MASWRK) THEN
+         WRITE(IW,*) '-------------------------'
+         WRITE(IW,*) 'DENSITY MATRIX'
+         WRITE(IW,*) '-------------------------'
+         WRITE(IW,*) 'STATE1=',IRT1-1,'STATE2=',IRT2-1
+         CALL PRTRIL(TDM,L1)
+      END IF
+      
       IF(MASWRK  .AND.  DBG) THEN
          WRITE(IW,9010)
          TDX=TRACEP(TDM,DAOX,L1)*DEBYE

